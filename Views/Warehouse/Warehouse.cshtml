@model IEnumerable<Agromarket.Models.WarehouseEntry>

@{
    ViewData["Title"] = "Складський облік";
}

<h2 class="mb-4">Складський облік</h2>

<!-- Кнопка додавання -->
<button class="btn btn-primary mb-3" id="openAddStockModal">➕ Додати товар на склад</button>

<table class="table table-bordered table-striped align-middle text-center">
    <thead class="table-light">
    <tr>
        <th>Назва</th>
        <th>Кількість</th>
        <th>Ціна закупівлі</th>
        <th>Ціна продажу</th>
        <th>Дата надходження</th>
        <th>Строк придатності</th>
        <th>Залишок</th>
        <th>Дії</th>
        <th>Передзамовлення</th>
        <th>Управління</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var entry in Model)
    {
        double? daysLeft = entry.ExpirationDate?.Subtract(DateTime.UtcNow).TotalDays;
        string shelfColor = daysLeft == null ? "text-muted" :
            daysLeft <= 0 ? "text-danger" :
            daysLeft <= 14 ? "text-warning" : "text-success";

        <tr>
            <td>@entry.Product.Name</td>
            <td>@entry.Quantity</td>
            <td>@entry.PurchasePrice.ToString("0.00") грн</td>
            <td>@(entry.SellingPrice?.ToString("0.00") ?? "-") грн</td>
            <td>@entry.ReceivedDate.ToShortDateString()</td>
            <td>@entry.ShelfLifeWeeks тиж.</td>
            <td>
                    <span class="@shelfColor">
                        @if (entry.ExpirationDate == null)
                        {
                            <text>—</text>
                        }
                        else if (daysLeft > 0)
                        {
                            <text>@((int)daysLeft) дн.</text>
                        }
                        else
                        {
                            <text>Закінчився</text>
                        }
                    </span>
            </td>

            <td>
                @if (entry.Quantity > 0)
                {
                    <form asp-controller="Warehouse" asp-action="DeductStock" method="post" class="d-flex gap-1 justify-content-center">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="entryId" value="@entry.Id" />
                        <input type="number" name="quantity" class="form-control form-control-sm w-50 text-center" min="1" max="@entry.Quantity" required />
                        <button type="submit" class="btn btn-sm btn-danger">Списати</button>
                    </form>
                }
                else
                {
                    <span class="text-muted">—</span>
                }
            </td>

            <td class="text-center align-middle">
                <input type="checkbox"
                       class="form-check-input preorder-toggle"
                       data-entry-id="@entry.Id"
                       @(entry.IsAvailableForPreorder ? "checked" : "") />
            </td>

            <td>
                <form asp-controller="Warehouse" asp-action="DeleteEntry" method="post" onsubmit="return confirm('Ви дійсно хочете видалити надходження?')">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="entryId" value="@entry.Id" />
                    <button type="submit" class="btn btn-sm btn-outline-secondary">🗑️</button>
                </form>
            </td>
        </tr>
    }
    </tbody>
</table>


<!-- Модальне вікно додавання надходження -->
<div class="modal fade" id="newReceiptModal" tabindex="-1" aria-labelledby="newReceiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Додати надходження</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрити"></button>
            </div>
            <form asp-controller="Warehouse" asp-action="ReceiveMultipleStock" method="post">
                <div class="modal-body">
                    <table class="table table-bordered">
                        <thead class="table-light text-center">
                        <tr>
                            <th>Товар</th>
                            <th>Кількість</th>
                            <th>Ціна закупівлі</th>
                            <th>Ціна продажу</th>
                            <th>Строк (тижні)</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="stockTableBody">
                        <tr class="stock-item">
                            <td>
                                <select name="entries[0].ProductId" class="form-select">
                                    @foreach (var product in ViewBag.Products)
                                    {
                                        <option value="@product.Id">@product.Name</option>
                                    }
                                </select>
                            </td>
                            <td><input type="number" name="entries[0].Quantity" class="form-control" min="1" required /></td>
                            <td><input type="number" step="0.01" name="entries[0].PurchasePrice" class="form-control" required /></td>
                            <td><input type="number" step="0.01" name="entries[0].SellingPrice" class="form-control" /></td>
                            <td><input type="number" name="entries[0].ShelfLifeWeeks" class="form-control" min="1" required /></td>
                            <td><button type="button" class="btn btn-danger remove-item">🗑</button></td>
                        </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-secondary" id="addStockItem">+ Додати рядок</button>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Зберегти</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".preorder-toggle").forEach(cb => {
            cb.addEventListener("change", function () {
                const entryId = this.dataset.entryId;
                const isAvailable = this.checked;

                fetch("/Warehouse/TogglePreorder", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ entryId, isAvailable })
                }).then(response => {   
                    if (!response.ok) {
                        alert("Помилка оновлення статусу передзамовлення.");
                        this.checked = !isAvailable;
                    }
                }).catch(() => {
                    alert("Помилка з'єднання.");
                    this.checked = !isAvailable;
                });
            });
        });
    });
        document.addEventListener("DOMContentLoaded", function () {
        const stockModal = new bootstrap.Modal(document.getElementById('newReceiptModal'));
        const openBtn = document.getElementById("openAddStockModal");

        openBtn?.addEventListener("click", () => {
        stockModal.show();
    });
    });

</script>

