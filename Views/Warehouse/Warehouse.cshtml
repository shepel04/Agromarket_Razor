@model IEnumerable<Agromarket.Models.Product>

@{
    ViewData["Title"] = "Складський облік";
}

<h2>Складський облік</h2>

<!-- Кнопка "Створити нове надходження" -->
<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#newReceiptModal">Створити нове надходження</button>

<!-- Таблиця товарів -->
<table class="table table-bordered table-responsive">
    <thead class="table-light">
    <tr>
        <th>Назва</th>
        <th>Кількість</th>
        <th>Одиниця</th>
        <th>Ціна закупівлі</th>
        <th>Ціна продажу</th>
        <th>Залишок строку придатності (тижні)</th>
        <th>Дії</th>
    </tr>
    </thead>
    <tbody>
    @if (!Model.Any())
    {
        <tr>
            <td colspan="7" class="text-center text-muted">Наразі немає товарів у складському обліку.</td>
        </tr>
    }
    else
    {
        @foreach (var product in Model)
        {
            bool isActive = product.StockQuantity > 0;
            string rowClass = isActive ? "" : "text-muted";
            string opacityStyle = isActive ? "" : "opacity: 0.6;";

            <tr class="@rowClass" style="@opacityStyle">
                <td>@product.Name</td>
                <td>@product.StockQuantity</td>
                <td>@product.Unit</td>
                <td>@(product.PurchasePrice.HasValue ? product.PurchasePrice.Value.ToString("0.00") + " грн" : "-")</td>
                <td>@(product.SellingPrice.HasValue ? product.SellingPrice.Value.ToString("0.00") + " грн" : "-")</td>
                <td>
                    @{
                        int remainingWeeks = product.GetRemainingShelfLife();
                        string color = remainingWeeks <= 1 ? "text-danger" : (remainingWeeks <= 2 ? "text-warning" : "text-success");
                    }
                    <span class="@color fw-bold">@remainingWeeks тиж.</span>
                </td>
                <td>
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deductModal-@product.Id">Списати</button>
                </td>
            </tr>

            <!-- Модальне вікно списання товару -->
            <div class="modal fade" id="deductModal-@product.Id" tabindex="-1" aria-labelledby="deductModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Списання товару: @product.Name</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form asp-controller="Warehouse" asp-action="DeductStock" method="post">
                            <div class="modal-body">
                                <input type="hidden" name="productId" value="@product.Id" />
                                <div class="mb-3">
                                    <label>Кількість для списання</label>
                                    <div class="input-group">
                                        <input type="number" id="deductQuantity-@product.Id" name="quantity" class="form-control" min="1" max="@product.StockQuantity" required />
                                        <button type="button" class="btn btn-outline-danger" onclick="setMaxQuantity(@product.Id, @product.StockQuantity)">Списати все</button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-danger">Списати</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        }
    }
    </tbody>
</table>

<!-- JavaScript для кнопки "Списати все" -->
<script>
    function setMaxQuantity(productId, maxQuantity) {
        document.getElementById("deductQuantity-" + productId).value = maxQuantity;
    }
</script>
