@model Agromarket.Models.WarehouseEntry

@{
    ViewData["Title"] = Model.Product.Name;

    var product = Model.Product;
    string base64 = product.ImageData != null ? Convert.ToBase64String(product.ImageData) : "";
    string imgSrc = !string.IsNullOrEmpty(base64) ? $"data:image/png;base64,{base64}" : "/img/no-image.png";

    bool isAvailable = Model.Quantity > 0 || Model.IsAvailableForPreorder;
    bool isPreorderOnly = Model.Quantity == 0 && Model.IsAvailableForPreorder;

    // Мапа українських місяців на номери
    var monthMap = new Dictionary<string, int>
    {
        ["Січень"] = 1, ["Лютий"] = 2, ["Березень"] = 3,
        ["Квітень"] = 4, ["Травень"] = 5, ["Червень"] = 6,
        ["Липень"] = 7, ["Серпень"] = 8, ["Вересень"] = 9,
        ["Жовтень"] = 10, ["Листопад"] = 11, ["Грудень"] = 12
    };

    DateTime now = DateTime.Now;
    int startMonth = monthMap.TryGetValue(product.SeasonStartMonth, out var sm) ? sm : 1;
    int endMonth = monthMap.TryGetValue(product.SeasonEndMonth, out var em) ? em : 12;

    DateTime firstDayOfSeason = new DateTime(now.Year, startMonth, 1);
    if (firstDayOfSeason < now)
    {
        firstDayOfSeason = new DateTime(now.Year + 1, startMonth, 1);
    }
    DateTime defaultDeliveryDate = firstDayOfSeason.AddDays(2);
    DateTime seasonEnd = new DateTime(firstDayOfSeason.Year, endMonth, 1).AddMonths(1).AddDays(-1);

    string deliveryInfo = "";
    if (Model.Quantity > 0)
    {
        deliveryInfo = "Доставка 1-3 дні";
    }
    else if (Model.IsAvailableForPreorder)
    {
        deliveryInfo = $"Ймовірна доставка з {defaultDeliveryDate:dd.MM.yyyy}";
    }
    else
    {
        deliveryInfo = "Наразі недоступно";
    }
}


<div class="container mt-4">
    <div class="card shadow-sm p-4">
        <div class="row">
            <div class="col-md-6 text-center d-flex align-items-center justify-content-center">
                <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal">
                    <img src="@imgSrc" class="product-image" alt="@product.Name">
                </a>
            </div>

            <div class="col-md-6">
                <h2 class="mb-3 text-center">@product.Name</h2>

                <p><strong>Ціна:</strong>
                    <span class="text-danger fs-4">
                        @(Model.SellingPrice.HasValue ? Model.SellingPrice.Value.ToString("0.00") + " грн" : "Не вказано")
                    </span>
                </p>

                <p><strong>Наявність:</strong>
                    @if (Model.Quantity > 0)
                    {
                        <span class="text-success">@Model.Quantity @product.Unit</span>
                    }
                    else if (Model.IsAvailableForPreorder)
                    {
                        <span class="text-warning">Доступно для передзамовлення</span>
                    }
                    else
                    {
                        <span class="text-danger">Недоступно</span>
                    }
                </p>

                <p><strong>Доставка:</strong> <span class="text-muted">@deliveryInfo</span></p>

                <p><strong>Сезон:</strong>
                    <span class="badge bg-info">@product.SeasonStartMonth - @product.SeasonEndMonth</span>
                </p>

                @if (isAvailable)
                {
                    <form asp-controller="Cart" asp-action="AddToCart" method="post" class="mt-4" onsubmit="return validateQuantity()">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="entryId" value="@Model.Id" />
                        <input type="hidden" name="productId" value="@product.Id" />
                        <input type="hidden" name="name" value="@product.Name" />
                        <input type="hidden" name="price" value="@Model.SellingPrice" />
                        <input type="hidden" name="unit" value="@product.Unit" />
                        <input type="hidden" name="imageBase64" value="@base64" />

                        @if (!isPreorderOnly)
                        {
                            <div class="mb-3 d-flex align-items-center">
                                <label for="quantity" class="me-2 fw-bold">Кількість:</label>
                                <input type="number"
                                       name="quantity"
                                       id="quantity"
                                       value="1"
                                       min="1"
                                       max="@Model.Quantity"
                                       class="form-control w-25 text-center" />
                            </div>
                        }
                        else
                        {
                            <input type="hidden" name="quantity" value="1" />
                            <div class="mb-3">
                                <label for="preorderDate" class="form-label fw-bold">Оберіть дату доставки:</label>
                                <input type="date" name="preorderDate" id="preorderDate" class="form-control"
                                       min="@defaultDeliveryDate.ToString("yyyy-MM-dd")"
                                       max="@seasonEnd.ToString("yyyy-MM-dd")"
                                       value="@defaultDeliveryDate.ToString("yyyy-MM-dd")" required />
                            </div>
                        }

                        <button type="submit" class="btn @(isPreorderOnly ? "btn-warning" : "btn-success") w-100 py-2">
                            <i class="bi @(isPreorderOnly ? "bi-clock-history" : "bi-cart-plus")"></i>
                            @(isPreorderOnly ? "Передзамовити" : "Додати в кошик")
                        </button>
                    </form>
                }

                <a href="@Url.Action("Catalog", "Warehouse")" class="btn btn-outline-secondary mt-3 w-100">← Назад до каталогу</a>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h4 class="mb-3">Опис товару</h4>
        <p class="text-muted">@product.Description</p>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@product.Name</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрити"></button>
            </div>
            <div class="modal-body text-center">
                <img src="@imgSrc" class="img-fluid enlarged-image" alt="@product.Name">
            </div>
        </div>
    </div>
</div>

<style>
    .product-image {
        width: 100%;
        max-width: 400px;
        height: 350px;
        object-fit: cover;
        border-radius: 8px;
        background: #f8f9fa;
        padding: 10px;
        cursor: pointer;
    }

    .enlarged-image {
        width: 100%;
        max-height: 90vh;
        object-fit: contain;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }

    .btn-success, .btn-warning {
        font-size: 1.1rem;
        transition: 0.3s;
    }

    .btn-success:hover, .btn-warning:hover {
        transform: scale(1.05);
    }

    .badge {
        font-size: 1rem;
        padding: 8px 12px;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("quantity");
        if (!input) return;

        const max = parseInt(input.getAttribute("max")) || Infinity;
        const min = parseInt(input.getAttribute("min")) || 1;

        input.addEventListener("input", () => {
            const value = parseInt(input.value);
            if (value > max) {
                input.value = max;
                alert("Введена кількість перевищує наявний залишок.");
            } else if (value < min) {
                input.value = min;
            }
        });

        const form = input.closest("form");
        form.addEventListener("submit", function (e) {
            const quantity = parseInt(input.value);
            if (quantity > max) {
                alert("Кількість перевищує залишок.");
                input.value = max;
                e.preventDefault();
            }
        });
    });
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
