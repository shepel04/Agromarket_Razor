@model IEnumerable<Agromarket.Models.Product>

@{
    ViewData["Title"] = "Список товарів";

    // список ID товарів, які є в обліку (передається через ViewBag)
    var warehouseProductIds = ViewBag.ProductsInWarehouse as HashSet<int> ?? new HashSet<int>();
}

<h2>Список товарів</h2>

<!-- Пошук -->
<form asp-action="ProductList" method="get" class="mb-3 d-flex">
    <input type="text" name="searchQuery" class="form-control me-2" placeholder="Пошук за назвою..." value="@Context.Request.Query["searchQuery"]">
    <button type="submit" class="btn btn-primary">🔍</button>
</form>

<!-- Сортування + Додавання -->
<div class="mb-3 d-flex justify-content-between">
    <div>
        <a asp-action="ProductList" asp-route-sortOrder="name_asc" class="btn btn-secondary">Сортувати А-Я</a>
        <a asp-action="ProductList" asp-route-sortOrder="name_desc" class="btn btn-secondary">Сортувати Я-А</a>
        <a asp-action="ProductList" asp-route-sortOrder="season" class="btn btn-secondary">Сортувати за сезонністю</a>
    </div>
    <a asp-action="AddProduct" class="btn btn-success">+ Додати товар</a>
</div>

<!-- Таблиця -->
<table class="table">
    <thead>
    <tr>
        <th>Фото</th>
        <th>Назва</th>
        <th>Опис</th>
        <th>Сезон</th>
        <th>Дії</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var product in Model)
    {
        bool isInSeason = product.IsInSeason();
        bool isInWarehouse = warehouseProductIds.Contains(product.Id);

        string rowClass = isInSeason ? "" : "inactive-product";
        string grayscaleStyle = isInSeason ? "" : "filter: grayscale(100%);";

        <tr class="@rowClass">
            <td>
                <div class="product-image-container">
                    @if (product.ImageData != null)
                    {
                        var base64 = Convert.ToBase64String(product.ImageData);
                        <img src="data:image/png;base64,@base64" alt="Фото товару" class="product-image" style="@grayscaleStyle" />
                    }
                    else
                    {
                        <span>Немає фото</span>
                    }
                </div>
            </td>
            <td>@product.Name</td>
            <td>@product.Description</td>
            <td>@product.SeasonStartMonth - @product.SeasonEndMonth</td>
            <td>
                <a asp-action="EditProduct" asp-route-id="@product.Id" class="btn btn-warning btn-sm">✏️ Редагувати</a>

                @if (!isInWarehouse)
                {
                    <form asp-action="Delete" method="post" style="display:inline;" onsubmit="return confirm('Ви впевнені, що хочете видалити цей товар?');">
                        <input type="hidden" name="id" value="@product.Id" />
                        <button type="submit" class="btn btn-danger btn-sm">🗑️ Видалити</button>
                    </form>
                }
                else
                {
                    <button class="btn btn-danger btn-sm" disabled>❌ Видалення заблоковано</button>
                }

                @if (isInSeason)
                {
                    <a asp-action="Warehouse" asp-controller="Warehouse" asp-route-selectedProductId="@product.Id" class="btn btn-success btn-sm">
                        📦 Створити надходження
                    </a>
                }
            </td>
        </tr>
    }
    </tbody>
</table>

<style>
    .inactive-product {
        color: gray !important;
        opacity: 0.6;
    }

    .product-image-container {
        display: inline-block;
    }

    .product-image {
        width: 100px;
        height: auto;
        display: block;
    }
</style>
